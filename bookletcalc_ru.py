"""
BookletCalc - Программа расчёта страниц для печати буклетом
Двусторонняя печать буклетом на A4 (2 страницы на лист)

Эта программа рассчитывает порядок страниц для ручной
двусторонней печати на принтере.
"""

import tkinter as tk
from tkinter import ttk, messagebox
import math
import os
import sys


def рассчитать_страницы(всего_страниц: int) -> tuple[str, str]:
    """
    Расчёт порядка страниц для буклетной печати.
    
    В формате буклета каждый лист содержит 4 позиции страниц:
    - Лицевая сторона: 2 страницы
    - Обратная сторона: 2 страницы
    
    Args:
        всего_страниц: Количество страниц в документе
        
    Returns:
        tuple: (первый_проход, второй_проход) - номера страниц через запятую
    """
    # Количество листов - делим на 4, округляем вверх
    кол_листов = math.ceil(всего_страниц / 4)
    
    # Общее количество позиций (с учётом пустых страниц)
    всего_позиций = кол_листов * 4
    
    # Первый проход (лицевая сторона листов)
    первый_проход = []
    
    # Второй проход (обратная сторона листов)
    второй_проход = []
    
    for лист in range(кол_листов):
        # Рассчитываем номера страниц для каждого листа
        
        # Лицевая сторона: [последняя - 2*лист, 1 + 2*лист]
        # Например, 8 страниц: лист 0 -> [8, 1], лист 1 -> [6, 3]
        лицо_лев = всего_позиций - (2 * лист)
        лицо_прав = 1 + (2 * лист)
        
        первый_проход.append(лицо_лев)
        первый_проход.append(лицо_прав)
        
        # Обратная сторона: [2 + 2*лист, последняя - 1 - 2*лист]
        # Например, 8 страниц: лист 0 -> [2, 7], лист 1 -> [4, 5]
        обр_лев = 2 + (2 * лист)
        обр_прав = всего_позиций - 1 - (2 * лист)
        
        второй_проход.append(обр_лев)
        второй_проход.append(обр_прав)
    
    # Форматирование (только существующие страницы)
    def форматировать(страницы: list[int]) -> str:
        """Форматирование номеров страниц через запятую"""
        существующие = [s for s in страницы if s <= всего_страниц]
        return ",".join(str(s) for s in существующие)
    
    return форматировать(первый_проход), форматировать(второй_проход)


def нажата_кнопка_рассчитать():
    """Обработчик нажатия кнопки Рассчитать"""
    введено = поле_ввода.get().strip()
    
    # Проверка: пустое или неверное значение
    if not введено:
        messagebox.showerror("Ошибка", "Пожалуйста, введите количество страниц!")
        return
    
    try:
        всего = int(введено)
    except ValueError:
        messagebox.showerror("Ошибка", "Пожалуйста, введите целое число!")
        return
    
    if всего < 1:
        messagebox.showerror("Ошибка", "Количество страниц должно быть не менее 1!")
        return
    
    if всего > 10000:
        messagebox.showerror("Ошибка", "Слишком много страниц (максимум 10000)!")
        return
    
    # Расчёт
    первый, второй = рассчитать_страницы(всего)
    
    # Отображение результатов
    поле_первый.config(state="normal")
    поле_первый.delete("1.0", tk.END)
    поле_первый.insert("1.0", первый)
    
    поле_второй.config(state="normal")
    поле_второй.delete("1.0", tk.END)
    поле_второй.insert("1.0", второй)
    
    # Информация
    листов = math.ceil(всего / 4)
    всего_позиций = листов * 4
    пустых = всего_позиций - всего
    
    if пустых > 0:
        метка_инфо.config(text=f"Всего: {всего} стр., {листов} листов. ({пустых} пустых страниц)")
    else:
        метка_инфо.config(text=f"Всего: {всего} стр., {листов} листов")


def копировать_первый():
    """Копировать первый проход в буфер обмена"""
    текст = поле_первый.get("1.0", tk.END).strip()
    if текст:
        окно.clipboard_clear()
        окно.clipboard_append(текст)
        messagebox.showinfo("Готово", "Первый проход скопирован!")


def копировать_второй():
    """Копировать второй проход в буфер обмена"""
    текст = поле_второй.get("1.0", tk.END).strip()
    if текст:
        окно.clipboard_clear()
        окно.clipboard_append(текст)
        messagebox.showinfo("Готово", "Второй проход скопирован!")


# === ГЛАВНОЕ ОКНО ===
окно = tk.Tk()
окно.title("BookletCalc - Расчёт страниц для буклета")
окно.geometry("500x400")
окно.resizable(True, True)

# Минимальный размер
окно.minsize(400, 350)

# Установка иконки
def путь_ресурса(относительный_путь):
    """Определение пути для работы с PyInstaller"""
    if hasattr(sys, '_MEIPASS'):
        return os.path.join(sys._MEIPASS, относительный_путь)
    return os.path.join(os.path.dirname(os.path.abspath(__file__)), относительный_путь)

try:
    окно.iconbitmap(путь_ресурса('icon.ico'))
except:
    pass  # Если иконка не найдена, используется стандартная

# === БЛОК ВВОДА ===
фрейм_ввод = ttk.Frame(окно, padding="10")
фрейм_ввод.pack(fill="x")

ttk.Label(фрейм_ввод, text="Количество страниц:", font=("Arial", 11)).pack(side="left")

поле_ввода = ttk.Entry(фрейм_ввод, width=15, font=("Arial", 11))
поле_ввода.pack(side="left", padx=10)

# Работа по Enter
поле_ввода.bind("<Return>", lambda e: нажата_кнопка_рассчитать())

кнопка_рассчитать = ttk.Button(фрейм_ввод, text="Рассчитать", command=нажата_кнопка_рассчитать)
кнопка_рассчитать.pack(side="left")

# === МЕТКА ИНФОРМАЦИИ ===
метка_инфо = ttk.Label(окно, text="", font=("Arial", 10), foreground="gray")
метка_инфо.pack(pady=5)

# === БЛОК РЕЗУЛЬТАТОВ ===

# Первый проход
фрейм_первый = ttk.LabelFrame(окно, text="1-й проход (лицевая сторона)", padding="10")
фрейм_первый.pack(fill="both", expand=True, padx=10, pady=5)

поле_первый = tk.Text(фрейм_первый, height=3, font=("Consolas", 10), wrap="word")
поле_первый.pack(fill="both", expand=True, side="left")

скролл_первый = ttk.Scrollbar(фрейм_первый, orient="vertical", command=поле_первый.yview)
скролл_первый.pack(side="right", fill="y")
поле_первый.config(yscrollcommand=скролл_первый.set)

кнопка_копир_первый = ttk.Button(окно, text="Копировать 1-й проход", command=копировать_первый)
кнопка_копир_первый.pack(pady=2)

# Второй проход
фрейм_второй = ttk.LabelFrame(окно, text="2-й проход (обратная сторона)", padding="10")
фрейм_второй.pack(fill="both", expand=True, padx=10, pady=5)

поле_второй = tk.Text(фрейм_второй, height=3, font=("Consolas", 10), wrap="word")
поле_второй.pack(fill="both", expand=True, side="left")

скролл_второй = ttk.Scrollbar(фрейм_второй, orient="vertical", command=поле_второй.yview)
скролл_второй.pack(side="right", fill="y")
поле_второй.config(yscrollcommand=скролл_второй.set)

кнопка_копир_второй = ttk.Button(окно, text="Копировать 2-й проход", command=копировать_второй)
кнопка_копир_второй.pack(pady=2)

# === ИНСТРУКЦИЯ ===
инструкция = ttk.Label(окно, text="1. Введите количество страниц\n2. Нажмите 'Рассчитать'\n3. Скопируйте результат в окно печати", 
                       font=("Arial", 9), foreground="gray", justify="center")
инструкция.pack(pady=10)

# === ЗАПУСК ПРОГРАММЫ ===
if __name__ == "__main__":
    окно.mainloop()
